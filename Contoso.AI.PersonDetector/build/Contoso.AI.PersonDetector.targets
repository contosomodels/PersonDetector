<Project>
  <PropertyGroup>
    <ModelUrl>https://huggingface.co/qualcomm/Yolo-X/resolve/f7d92bb30d876f4c7dd485b4d30776583b8fbae4/Yolo-X_w8a8.onnx.zip</ModelUrl>
    <ModelZipFileName>Yolo-X_w8a8.onnx.zip</ModelZipFileName>
    <ModelFileName>model.onnx</ModelFileName>
    <ModelDataFileName>model.data</ModelDataFileName>
    <ModelFolderName>Yolo-X_w8a8</ModelFolderName>
    <!-- Download to intermediate output directory to avoid polluting source control -->
    <ModelDirectory>$(MSBuildProjectDirectory)\obj\Models</ModelDirectory>
    <ModelExtractDirectory>$(ModelDirectory)\$(ModelFolderName)</ModelExtractDirectory>
  </PropertyGroup>

  <!-- Download model at build time for consuming projects -->
  <Target Name="DownloadPersonDetectionModel" BeforeTargets="BeforeBuild">
    <PropertyGroup>
      <ModelZipFilePath>$(ModelDirectory)\$(ModelZipFileName)</ModelZipFilePath>
      <ModelFilePath>$(ModelExtractDirectory)\$(ModelFileName)</ModelFilePath>
      <ModelDataFilePath>$(ModelExtractDirectory)\$(ModelDataFileName)</ModelDataFilePath>
    </PropertyGroup>
    
    <!-- Create Models directory if it doesn't exist -->
    <MakeDir Directories="$(ModelDirectory)" Condition="!Exists('$(ModelDirectory)')" />
    <MakeDir Directories="$(ModelExtractDirectory)" Condition="!Exists('$(ModelExtractDirectory)')" />
    
    <!-- Download model if it doesn't exist -->
    <Message Text="[Contoso.AI.PersonDetector] Checking for model at: $(ModelFilePath)" Importance="high" />
    <Message Text="[Contoso.AI.PersonDetector] Model already exists, skipping download." Importance="high" Condition="Exists('$(ModelFilePath)')" />
    
    <!-- Download ZIP file -->
    <DownloadFile 
      SourceUrl="$(ModelUrl)" 
      DestinationFolder="$(ModelDirectory)"
      DestinationFileName="$(ModelZipFileName)"
      Condition="!Exists('$(ModelFilePath)')"
      SkipUnchangedFiles="true" />
      
    <Message Text="[Contoso.AI.PersonDetector] Model ZIP downloaded successfully to: $(ModelZipFilePath)" Importance="high" Condition="!Exists('$(ModelFilePath)') AND Exists('$(ModelZipFilePath)')" />
    
    <!-- Extract ZIP file to temporary location -->
    <Unzip 
      SourceFiles="$(ModelZipFilePath)" 
      DestinationFolder="$(ModelDirectory)\temp"
      Condition="!Exists('$(ModelFilePath)') AND Exists('$(ModelZipFilePath)')" />
      
    <!-- Move extracted files to stable location -->
    <ItemGroup>
      <ExtractedModelFiles Include="$(ModelDirectory)\temp\**\*.onnx" />
      <ExtractedModelFiles Include="$(ModelDirectory)\temp\**\*.data" />
    </ItemGroup>
    
    <Copy
      SourceFiles="@(ExtractedModelFiles)"
      DestinationFolder="$(ModelExtractDirectory)"
      Condition="!Exists('$(ModelFilePath)')" />
      
    <!-- Clean up temp directory -->
    <RemoveDir Directories="$(ModelDirectory)\temp" Condition="Exists('$(ModelDirectory)\temp')" />
      
    <Message Text="[Contoso.AI.PersonDetector] Model extracted successfully to: $(ModelExtractDirectory)" Importance="high" Condition="Exists('$(ModelFilePath)')" />
    
    <!-- Add the model files to content items so they get copied to output -->
    <ItemGroup>
      <Content Include="$(ModelFilePath)" Condition="Exists('$(ModelFilePath)')">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        <Link>Models\$(ModelFolderName)\$(ModelFileName)</Link>
      </Content>
      <Content Include="$(ModelDataFilePath)" Condition="Exists('$(ModelDataFilePath)')">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        <Link>Models\$(ModelFolderName)\$(ModelDataFileName)</Link>
      </Content>
    </ItemGroup>
  </Target>
</Project>
